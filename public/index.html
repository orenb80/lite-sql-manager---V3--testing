<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Server Manager</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Connection Page -->
    <div id="connectionPage" class="container login-container">
        <h1>üóÑÔ∏è Connect to SQL Server</h1>
        <form id="connectionForm">
            <div class="form-group">
                <label for="server">Server Address</label>
                <input type="text" id="server" placeholder="localhost" required>
            </div>
            <div class="form-group">
                <label>Authentication Type</label>
                <select id="authType" onchange="toggleAuthFields()">
                    <option value="sql">SQL Server Authentication</option>
                    <option value="windows">Windows Authentication (Current User)</option>
                    <option value="windowsCustom">Windows Authentication (Specify User)</option>
                </select>
            </div>
            <div id="sqlAuthFields">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="sa">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password">
                </div>
            </div>
            <div id="windowsCustomFields" style="display: none;">
                <div class="form-group">
                    <label for="windowsDomain">Domain (Optional)</label>
                    <input type="text" id="windowsDomain" placeholder="DOMAIN or leave empty">
                    <div class="help-text">Leave empty for local machine account</div>
                </div>
                <div class="form-group">
                    <label for="windowsUsername">Windows Username</label>
                    <input type="text" id="windowsUsername" placeholder="username">
                </div>
                <div class="form-group">
                    <label for="windowsPassword">Windows Password</label>
                    <input type="password" id="windowsPassword">
                </div>
            </div>
            <div class="form-group">
                <label for="database">Database (Optional)</label>
                <input type="text" id="database" placeholder="Leave empty">
            </div>
            <div class="checkbox-group">
                <label><input type="checkbox" id="encrypt">Encrypt Connection</label>
                <label><input type="checkbox" id="trustCertificate" checked>Trust Certificate</label>
            </div>
            <button type="submit" style="margin-top: 20px;">Connect</button>
            <div id="connectionError" class="error hidden"></div>
        </form>
    </div>

    <!-- Main Application Page -->
    <div id="mainPage" class="container hidden">
        <div class="app-header">
            <div class="connection-info">
                <span class="connection-text">
                    <strong>Connected to:</strong> <span id="serverInfo"></span> | <strong>User:</strong> <span id="userInfo"></span>
                </span>
                <div class="header-buttons">
                    <button class="history-toggle-btn" onclick="QueryHistory.toggleHistoryPanel()">üìú History</button>
                    <button class="disconnect-btn" onclick="disconnect()">Disconnect</button>
                </div>
            </div>
        </div>
        <h1>üìä SQL Server Manager</h1>
        
        <!-- Mode Tabs -->
        <div class="mode-tabs">
            <button class="mode-tab active" onclick="switchMode('simple')">üîç Simple Search</button>
            <button class="mode-tab" onclick="switchMode('custom')">‚úèÔ∏è Custom SQL</button>
            <button class="mode-tab" onclick="switchMode('joins')">üîó Join Tables</button>
            <button class="mode-tab" onclick="switchMode('aggregations')">üìä Aggregations</button>
            <button class="mode-tab" onclick="switchMode('schema')">üóÇÔ∏è Schema Viewer</button>
            <button class="mode-tab" onclick="switchMode('backup')">üíæ Backup & Restore</button>
        </div>
        
        <!-- Simple Search Mode -->
        <div id="simpleMode">
            <div class="selection-section">
                <h2>Select Database & Table</h2>
                <div class="db-table-selector">
                    <div class="form-group">
                        <label for="databaseSelect">Database</label>
                        <select id="databaseSelect" onchange="loadTables()">
                            <option value="">-- Select Database --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tableSelect">Table</label>
                        <select id="tableSelect" onchange="loadColumns()" disabled>
                            <option value="">-- Select Table --</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="searchSection" class="hidden">
                <div class="search-criteria">
                    <h2>Search Criteria</h2>
                    <div id="criteriaContainer"></div>
                    <button class="add-criteria-btn" onclick="addCriteria()">+ Add Field</button>
                    
                    <div class="advanced-options">
                        <div class="form-group">
                            <label for="resultLimit">Result Limit</label>
                            <select id="resultLimit">
                                <option value="100">100 rows</option>
                                <option value="500">500 rows</option>
                                <option value="1000" selected>1,000 rows</option>
                                <option value="5000">5,000 rows</option>
                                <option value="10000">10,000 rows</option>
                                <option value="">No limit (max 50K)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="orderByColumn">Order By</label>
                            <select id="orderByColumn">
                                <option value="">-- None --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="orderDirection">Direction</label>
                            <select id="orderDirection">
                                <option value="ASC">Ascending</option>
                                <option value="DESC">Descending</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="checkbox-group" style="margin-top: 15px;">
                        <label><input type="checkbox" id="distinctResults">DISTINCT (unique rows only)</label>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <button onclick="performSearch()">üîç Search</button>
                    <button onclick="showInsertModal()" style="background: #34a853;">‚ûï Add Record</button>
                    <button onclick="clearSearchAndResults()" style="background: #95a5a6;">üßπ Clear</button>
                </div>
            </div>
        </div>
        
        <!-- Custom SQL Mode -->
        <div id="customMode" class="hidden">
            <div class="selection-section">
                <h2>Custom SQL Query</h2>
                <div class="form-group">
                    <label for="customDatabase">Database</label>
                    <select id="customDatabase">
                        <option value="">-- Select Database --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="customQuery">SQL Query</label>
                    <textarea id="customQuery" placeholder="SELECT * FROM [schema].[table] WHERE ..."></textarea>
                    <div class="help-text">Write any SELECT query. Example: SELECT TOP 100 * FROM dbo.Users WHERE Age > 25 ORDER BY Name</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <button onclick="executeCustomQuery()">‚ñ∂Ô∏è Execute Query</button>
                    <button onclick="clearCustomQuery()" style="background: #95a5a6;">üßπ Clear</button>
                </div>
            </div>
        </div>
        
        <!-- Join Tables Mode -->
        <div id="joinsMode" class="hidden">
            <div class="selection-section">
                <h2>Join Tables</h2>
                <div class="form-group">
                    <label for="joinDatabase">Database</label>
                    <select id="joinDatabase" onchange="JoinsBuilder.loadTablesForJoins()">
                        <option value="">-- Select Database --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="joinPrimaryTable">Primary Table</label>
                    <select id="joinPrimaryTable" onchange="JoinsBuilder.setPrimaryTable()">
                        <option value="">-- Select Primary Table --</option>
                    </select>
                </div>
                
                <div id="joinControls" class="hidden">
                    <h3 style="color: #c5c7ca; margin: 20px 0 15px 0; font-size: 14px;">Build Joins</h3>
                    <div id="joinsContainer"></div>
                    
                    <h3 style="color: #c5c7ca; margin: 30px 0 15px 0; font-size: 14px;">Generated SQL</h3>
                    <textarea id="joinSQLPreview" readonly></textarea>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        <button id="executeJoinBtn" onclick="JoinsBuilder.executeJoin()">‚ñ∂Ô∏è Execute Join</button>
                        <button onclick="JoinsBuilder.clear()" style="background: #95a5a6;">üßπ Clear</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Aggregations Mode -->
        <div id="aggregationsMode" class="hidden">
            <div class="selection-section">
                <h2>Build Aggregation Query</h2>
                <div class="form-group">
                    <label for="aggDatabase">Database</label>
                    <select id="aggDatabase" onchange="AggregationsBuilder.loadTablesForAgg()">
                        <option value="">-- Select Database --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="aggTable">Table</label>
                    <select id="aggTable" onchange="AggregationsBuilder.loadColumnsForAgg()">
                        <option value="">-- Select Table --</option>
                    </select>
                </div>
                
                <div id="aggControls" class="hidden">
                    <h3 style="color: #c5c7ca; margin: 20px 0 15px 0; font-size: 14px;">Select Columns</h3>
                    <div id="aggColumnsContainer"></div>
                    
                    <h3 style="color: #c5c7ca; margin: 20px 0 15px 0; font-size: 14px;">Aggregate Functions</h3>
                    <div id="aggFunctionsContainer"></div>
                    <button class="add-criteria-btn" onclick="AggregationsBuilder.addAggregateFunction()">+ Add Function</button>
                    
                    <h3 style="color: #c5c7ca; margin: 20px 0 15px 0; font-size: 14px;">GROUP BY Columns</h3>
                    <div id="aggGroupByContainer"></div>
                    
                    <h3 style="color: #c5c7ca; margin: 20px 0 15px 0; font-size: 14px;">HAVING Conditions (Optional)</h3>
                    <div id="aggHavingContainer"></div>
                    <button class="add-criteria-btn" onclick="AggregationsBuilder.addHavingCondition()">+ Add Condition</button>
                    
                    <h3 style="color: #c5c7ca; margin: 30px 0 15px 0; font-size: 14px;">Generated SQL</h3>
                    <textarea id="aggSQLPreview" readonly></textarea>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        <button id="executeAggBtn" onclick="AggregationsBuilder.executeAggregation()">‚ñ∂Ô∏è Execute Query</button>
                        <button onclick="AggregationsBuilder.clear()" style="background: #95a5a6;">üßπ Clear</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Schema Viewer Mode -->
        <div id="schemaMode" class="hidden">
            <div class="selection-section">
                <h2>View Table Schema</h2>
                <div class="form-group">
                    <label for="schemaDatabase">Database</label>
                    <select id="schemaDatabase" onchange="SchemaViewer.loadTablesForSchema()">
                        <option value="">-- Select Database --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="schemaTable">Table</label>
                    <select id="schemaTable" onchange="SchemaViewer.loadTableSchema()">
                        <option value="">-- Select Table --</option>
                    </select>
                </div>
                
                <div id="schemaDetails" class="hidden">
                    <h3 style="color: #c5c7ca; margin: 20px 0 15px 0; font-size: 16px;">Table Information</h3>
                    <div id="schemaTableInfo"></div>
                    
                    <h3 style="color: #c5c7ca; margin: 20px 0 15px 0; font-size: 16px;">Columns</h3>
                    <div id="schemaColumns"></div>
                    
                    <h3 style="color: #c5c7ca; margin: 20px 0 15px 0; font-size: 16px;">Primary Keys</h3>
                    <div id="schemaPrimaryKeys"></div>
                    
                    <h3 style="color: #c5c7ca; margin: 20px 0 15px 0; font-size: 16px;">Foreign Keys</h3>
                    <div id="schemaForeignKeys"></div>
                    
                    <h3 style="color: #c5c7ca; margin: 20px 0 15px 0; font-size: 16px;">Indexes</h3>
                    <div id="schemaIndexes"></div>
                </div>
            </div>
        </div>
        
        <!-- Backup & Restore Mode -->
        <div id="backupMode" class="hidden">
            <div class="selection-section">
                <h2>üíæ Database Backup</h2>
                <div class="form-group">
                    <label for="backupDatabaseSelect">Select Database</label>
                    <select id="backupDatabaseSelect">
                        <option value="">-- Select Database --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="backupType">Backup Type</label>
                    <select id="backupType">
                        <option value="FULL">Full Backup (Complete database)</option>
                        <option value="DIFFERENTIAL">Differential Backup (Changes since last full)</option>
                        <option value="LOG">Transaction Log Backup</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="backupPath">Backup File Path</label>
                    <div class="input-with-button">
                        <input type="text" id="backupPath" placeholder="C:\Backup\MyDatabase.bak">
                        <button type="button" class="browse-btn-dots" onclick="BackupModule.openServerBrowser('backupPath')" title="Browse SQL Server files">‚ãØ</button>
                    </div>
                    <div class="help-text">üìÅ Click ‚ãØ to browse files on SQL Server machine, or type path manually</div>
                </div>
                <div class="form-group">
                    <label for="backupDescription">Description (Optional)</label>
                    <input type="text" id="backupDescription" placeholder="Monthly backup">
                </div>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="backupCompression" checked>Compress backup (recommended)</label>
                </div>
                <button onclick="BackupModule.performBackup()" style="margin-top: 15px;">üíæ Start Backup</button>
            </div>

            <div class="selection-section" id="restoreSection">
                <h2>üì• Database Restore</h2>
                <div class="form-group">
                    <label for="restoreBackupPath">Backup File Path</label>
                    <div class="input-with-button">
                        <input type="text" id="restoreBackupPath" placeholder="C:\Backup\MyDatabase.bak">
                        <button type="button" class="browse-btn-dots" onclick="BackupModule.openServerBrowser('restoreBackupPath')" title="Browse SQL Server files">‚ãØ</button>
                    </div>
                    <div class="help-text">üìÅ Click ‚ãØ to browse .bak files on SQL Server machine</div>
                </div>
                <div class="form-group">
                    <label for="restoreDatabaseSelect">Target Database</label>
                    <select id="restoreDatabaseSelect">
                        <option value="">-- Same as backup --</option>
                    </select>
                    <div class="help-text">Leave as default to restore with original database name, or select a different database</div>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="restoreReplace">
                        Replace existing database (‚ö†Ô∏è WARNING: This will overwrite the existing database!)
                    </label>
                </div>
                <button onclick="BackupModule.performRestore()" style="margin-top: 15px;">üì• Start Restore</button>
            </div>

            <div class="selection-section" id="verifySection">
                <h2>üîç Verify Backup</h2>
                <div class="form-group">
                    <label for="verifyBackupPath">Backup File Path</label>
                    <div class="input-with-button">
                        <input type="text" id="verifyBackupPath" placeholder="C:\Backup\MyDatabase.bak">
                        <button type="button" class="browse-btn-dots" onclick="BackupModule.openServerBrowser('verifyBackupPath')" title="Browse SQL Server files">‚ãØ</button>
                    </div>
                    <div class="help-text">üìÅ Click ‚ãØ to browse .bak files on SQL Server machine</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <button onclick="BackupModule.verifyBackup()">üîç Verify Backup</button>
                    <button onclick="BackupModule.getBackupInfo()">üìã Get File Info</button>
                </div>
                <div id="verifyResults" style="margin-top: 20px;"></div>
            </div>

            <div class="selection-section">
                <h2>üìú Backup History</h2>
                <button onclick="BackupModule.loadBackupHistory()" style="margin-bottom: 15px;">üîÑ Refresh</button>
                <div id="backupHistory">
                    <p class="no-data">Click Refresh to load backup history</p>
                </div>
            </div>
        </div>
        
        <!-- Messages -->
        <div id="message" class="hidden"></div>
        
        <!-- Results -->
        <div id="resultsContainer" class="hidden">
            <div class="results-header">
                <h2>Results <span class="badge" id="resultCount">0</span></h2>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportToCSV()">üìÑ Export CSV</button>
                    <button class="export-btn" onclick="exportToJSON()">üìã Export JSON</button>
                    <button class="export-btn" onclick="exportToExcel()">üìä Export Excel</button>
                </div>
            </div>
            <div class="results-table" id="resultsTable"></div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Confirm Deletion</h3>
            <p id="deleteWarning">Are you sure you want to delete this record? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
                <button class="delete-btn-inline" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Record Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Edit Record</h3>
            <p id="editWarning" class="hidden warning"></p>
            <div id="editFormContainer"></div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="edit-btn-inline" onclick="confirmUpdate()">Update</button>
            </div>
        </div>
    </div>

    <!-- Insert Record Modal -->
    <div id="insertModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Add New Record</h3>
            <p id="insertInfo" class="info-message">Fill in the fields below. Leave empty for NULL values.</p>
            <div id="insertFormContainer"></div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeInsertModal()">Cancel</button>
                <button class="edit-btn-inline" onclick="confirmInsert()">Insert</button>
            </div>
        </div>
    </div>

    <!-- Insert Record Modal -->
    <div id="insertModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Add New Record</h3>
            <p id="insertWarning" class="hidden warning"></p>
            <div id="insertFormContainer"></div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeInsertModal()">Cancel</button>
                <button class="edit-btn-inline" onclick="confirmInsert()">Insert</button>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <div id="historyPanel" class="history-panel hidden">
        <div class="history-panel-header">
            <h3>üìú Query History</h3>
            <button class="history-close-btn" onclick="QueryHistory.toggleHistoryPanel()">‚úï</button>
        </div>
        <div class="history-content">
            <div class="history-section">
                <div class="history-section-header">
                    <h4>‚≠ê Favorites</h4>
                    <button class="history-clear-btn" onclick="QueryHistory.clearFavorites()">Clear</button>
                </div>
                <div id="favoritesList"></div>
            </div>
            <div class="history-section">
                <div class="history-section-header">
                    <h4>üïê Recent (Last 20)</h4>
                    <button class="history-clear-btn" onclick="QueryHistory.clearHistory()">Clear</button>
                </div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <!-- XLSX Library for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- JavaScript Files -->
    <script src="js/app.js"></script>
    <script src="js/query.js"></script>
    <script src="js/crud.js"></script>
    <script src="js/export.js"></script>
    <script src="js/history.js"></script>
    <script src="js/joins.js"></script>
    <script src="js/aggregations.js"></script>
    <script src="js/schema.js"></script>
    <script src="js/backup.js"></script>
</body>
</html>